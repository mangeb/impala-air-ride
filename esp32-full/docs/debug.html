<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Impala Air Ride - Debug Console</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Courier New', monospace; background: #1a1a1a; color: #e0e0e0; padding: 10px; font-size: 14px; }
  h1 { font-size: 16px; color: #ffd700; margin-bottom: 8px; text-align: center; }
  h2 { font-size: 13px; color: #aaa; margin: 8px 0 4px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 2px; }

  .config { display: flex; gap: 6px; margin-bottom: 8px; align-items: center; }
  .config input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 4px 8px; border-radius: 4px; font-family: inherit; font-size: 13px; }
  .config button { background: #333; border: 1px solid #555; color: #fff; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-family: inherit; }
  .config button:hover { background: #444; }

  .status-bar { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
  .dot { width: 10px; height: 10px; border-radius: 50%; background: #555; display: inline-block; }
  .dot.ok { background: #4caf50; }
  .dot.err { background: #f44336; }
  #poll-toggle { font-size: 12px; cursor: pointer; background: #333; border: 1px solid #555; color: #fff; padding: 2px 8px; border-radius: 4px; }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px; }
  .bag-card { background: #222; border: 1px solid #333; border-radius: 6px; padding: 8px; }
  .bag-card .name { font-weight: bold; color: #ffd700; font-size: 13px; }
  .bag-card .psi { font-size: 20px; font-weight: bold; color: #fff; margin: 2px 0; }
  .bag-card .target { font-size: 11px; color: #888; }
  .bag-card .timeout { font-size: 11px; color: #f44336; }
  .bag-btns { display: flex; gap: 4px; margin-top: 4px; }
  .bag-btns button { flex: 1; padding: 6px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: bold; }
  .bag-btns .inflate { background: #2e7d32; color: #fff; }
  .bag-btns .hold { background: #555; color: #fff; }
  .bag-btns .deflate { background: #c62828; color: #fff; }
  .bag-btns button:active { opacity: 0.7; }

  .target-input { display: flex; gap: 4px; margin-top: 4px; align-items: center; }
  .target-input input { width: 50px; background: #111; border: 1px solid #444; color: #fff; padding: 3px 4px; border-radius: 3px; font-family: inherit; font-size: 12px; text-align: center; }
  .target-input button { padding: 3px 8px; font-size: 11px; background: #1565c0; color: #fff; border: none; border-radius: 3px; cursor: pointer; font-family: inherit; }

  .tank-bar { background: #222; border: 1px solid #333; border-radius: 6px; padding: 8px; margin-bottom: 6px; }
  .tank-bar .label { font-size: 12px; color: #888; }
  .tank-bar .value { font-size: 24px; font-weight: bold; color: #fff; }
  .tank-bar .bar { height: 8px; background: #333; border-radius: 4px; margin-top: 4px; overflow: hidden; }
  .tank-bar .bar-fill { height: 100%; background: linear-gradient(90deg, #c62828, #ffd700, #4caf50); border-radius: 4px; transition: width 0.3s; }
  .lockout-warn { color: #f44336; font-size: 11px; font-weight: bold; }

  .section { margin-bottom: 6px; }
  .btn-row { display: flex; gap: 4px; flex-wrap: wrap; }
  .btn-row button { padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; color: #fff; }
  .btn-row button:active { opacity: 0.7; }
  .preset { background: #1565c0; }
  .preset.active { background: #0d47a1; box-shadow: 0 0 0 2px #64b5f6; }
  .level { background: #6a1b9a; }
  .level.active { background: #4a148c; box-shadow: 0 0 0 2px #ce93d8; }
  .memory { background: #00695c; }
  .pump { background: #e65100; }
  .pump.off { background: #555; }
  .demo { background: #ff6f00; color: #fff; padding: 6px 12px; font-size: 12px; border: none; border-radius: 4px; cursor: pointer; font-family: inherit; font-weight: bold; }
  .demo:active { opacity: 0.7; }
  .demo.off { background: #555; }
  .demo-status { font-size: 12px; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
  .demo-status.on { background: #ff6f00; color: #000; }
  .demo-status.off { background: #333; color: #888; }
  .all-ctrl { background: #333; border: 1px solid #555; }

  .pump-status { display: flex; gap: 8px; align-items: center; margin-top: 4px; font-size: 12px; }
  .pump-led { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #555; }
  .pump-led.on { background: #ffa726; border-color: #ffa726; box-shadow: 0 0 6px #ffa726; }
  .pump-led.off { background: #333; }

  #log { background: #111; border: 1px solid #333; border-radius: 4px; padding: 6px; font-size: 11px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; color: #888; margin-top: 6px; }
  #log .req { color: #64b5f6; }
  #log .res { color: #81c784; }
  #log .err { color: #ef5350; }
  #raw { background: #0a0a0a; border: 1px solid #333; border-radius: 4px; padding: 6px; font-size: 11px; max-height: 120px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; color: #666; margin-top: 4px; }

  .cal-card { background: #222; border: 1px solid #333; border-radius: 6px; padding: 8px; margin-bottom: 6px; }
  .cal-card .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .cal-card .cal-name { font-weight: bold; color: #ffd700; font-size: 13px; }
  .cal-card .cal-badge { font-size: 10px; padding: 1px 6px; border-radius: 3px; }
  .cal-badge.factory { background: #333; color: #888; }
  .cal-badge.calibrated { background: #2e7d32; color: #fff; }
  .cal-card .cal-values { font-size: 11px; color: #aaa; margin-bottom: 4px; }
  .cal-card .cal-psi { font-size: 16px; font-weight: bold; color: #fff; }
  .cal-row { display: flex; gap: 4px; align-items: center; margin-top: 4px; flex-wrap: wrap; }
  .cal-row input { width: 60px; background: #111; border: 1px solid #444; color: #fff; padding: 3px 4px; border-radius: 3px; font-family: inherit; font-size: 12px; text-align: center; }
  .cal-row button { padding: 3px 8px; font-size: 11px; border: none; border-radius: 3px; cursor: pointer; font-family: inherit; color: #fff; }
  .cal-row button:active { opacity: 0.7; }
  .cal-row .cal-label { font-size: 11px; color: #888; min-width: 30px; }
</style>
</head>
<body>

<h1>IMPALA AIR RIDE - DEBUG CONSOLE</h1>

<div class="config">
  <label>ESP32:</label>
  <input type="text" id="base-url" value="http://192.168.4.1" placeholder="http://192.168.4.1">
  <button onclick="pollNow()">Refresh</button>
</div>

<div class="status-bar">
  <span class="dot" id="conn-dot"></span>
  <span id="conn-text" style="font-size:12px;color:#888">Disconnected</span>
  <button id="poll-toggle" onclick="togglePoll()">Auto-poll: OFF</button>
  <span style="font-size:11px;color:#555;margin-left:auto" id="last-update"></span>
</div>

<!-- Demo Mode -->
<div class="section">
  <h2>Simulation Mode</h2>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="demo" id="demo-toggle-btn" onclick="toggleDemo()">Toggle Demo</button>
    <span class="demo-status off" id="demo-status">DEMO: OFF</span>
    <span style="font-size:11px;color:#666">Simulates sensors &amp; tank physics on ESP32</span>
  </div>
</div>

<!-- Tank -->
<div class="tank-bar">
  <div style="display:flex;justify-content:space-between;align-items:baseline">
    <span class="label">TANK</span>
    <span class="value" id="tank-psi">--</span>
    <span class="label">PSI</span>
    <span class="lockout-warn" id="lockout-warn" style="display:none">LOCKOUT</span>
  </div>
  <div class="bar"><div class="bar-fill" id="tank-bar-fill" style="width:0%"></div></div>
</div>

<!-- Bags -->
<div class="grid" id="bags-grid">
  <!-- Populated by JS -->
</div>

<!-- All Bags -->
<div class="section">
  <h2>All Bags</h2>
  <div class="btn-row">
    <button class="all-ctrl" onmousedown="allBags(1)" onmouseup="allBagsHold()" ontouchstart="ev(event);allBags(1)" ontouchend="ev(event);allBagsHold()">Rise All</button>
    <button class="all-ctrl" onmousedown="allBags(-1)" onmouseup="allBagsHold()" ontouchstart="ev(event);allBags(-1)" ontouchend="ev(event);allBagsHold()">Drop All</button>
    <button class="all-ctrl" onclick="allBagsHold()">Hold All</button>
  </div>
</div>

<!-- Presets -->
<div class="section">
  <h2>Presets</h2>
  <div class="btn-row">
    <button class="preset" onclick="applyPreset(0)">Lay (0)</button>
    <button class="preset" onclick="applyPreset(1)">Cruise (1)</button>
    <button class="preset" onclick="applyPreset(2)">Max (2)</button>
  </div>
  <div style="margin-top:4px">
    <div class="btn-row">
      <button class="preset" style="background:#0d47a1;font-size:11px" onclick="savePreset(0)">Save Lay</button>
      <button class="preset" style="background:#0d47a1;font-size:11px" onclick="savePreset(1)">Save Cruise</button>
      <button class="preset" style="background:#0d47a1;font-size:11px" onclick="savePreset(2)">Save Max</button>
    </div>
  </div>
  <div id="preset-values" style="font-size:11px;color:#666;margin-top:2px"></div>
</div>

<!-- Level Mode -->
<div class="section">
  <h2>Level Mode</h2>
  <div class="btn-row">
    <button class="level" id="level-0" onclick="setLevel(0)">Off</button>
    <button class="level" id="level-1" onclick="setLevel(1)">Front</button>
    <button class="level" id="level-2" onclick="setLevel(2)">Rear</button>
    <button class="level" id="level-3" onclick="setLevel(3)">All</button>
  </div>
</div>

<!-- Pump Control -->
<div class="section">
  <h2>Pumps</h2>
  <div class="btn-row">
    <button class="pump" id="pump-toggle-btn" onclick="togglePump()">Toggle Enable</button>
  </div>
  <div class="pump-status">
    <span>Enabled: <strong id="pump-enabled">--</strong></span>
    <span>Mode: <strong id="pump-mode">--</strong></span>
    <div class="pump-led off" id="p1-led"></div><span>P1</span>
    <div class="pump-led off" id="p2-led"></div><span>P2</span>
  </div>
  <div style="font-size:11px;color:#666;margin-top:2px" id="pump-runtime"></div>
  <div style="font-size:11px;color:#f44336;margin-top:2px" id="pump-maint"></div>
</div>

<!-- Tank Maintenance -->
<div class="section">
  <h2>Tank Maintenance Timer</h2>
  <div style="font-size:12px;margin-bottom:4px">
    <span>Status: <strong id="tank-maint-status" style="color:#888">--</strong></span>
    <span style="margin-left:12px">Days Remaining: <strong id="tank-maint-days" style="color:#888">--</strong></span>
  </div>
  <div style="font-size:11px;color:#666;margin-bottom:4px" id="tank-maint-last">Last service: --</div>
  <div class="btn-row">
    <button class="memory" onclick="resetTankMaint()">Service Complete (Reset)</button>
    <button class="preset" style="background:#6a1b9a;font-size:11px" onclick="setTankMaintDate()">Set Custom Date</button>
  </div>
</div>

<!-- Simulated Leak -->
<div class="section">
  <h2>Simulated Leak (Demo Mode)</h2>
  <div style="font-size:12px;margin-bottom:4px">
    <span>Status: <strong id="simleak-status" style="color:#888">INACTIVE</strong></span>
    <span style="margin-left:12px">Target: <strong id="simleak-target" style="color:#888">--</strong></span>
  </div>
  <div class="btn-row" style="margin-bottom:4px">
    <button style="background:#c62828;color:#fff;font-weight:bold" onclick="startSimLeak('random')">ðŸ”´ Random Leak</button>
    <button style="background:#c62828;color:#fff" onclick="startSimLeak(0)">Leak FL</button>
    <button style="background:#c62828;color:#fff" onclick="startSimLeak(1)">Leak FR</button>
    <button style="background:#c62828;color:#fff" onclick="startSimLeak(2)">Leak RL</button>
    <button style="background:#c62828;color:#fff" onclick="startSimLeak(3)">Leak RR</button>
    <button style="background:#c62828;color:#fff" onclick="startSimLeak(4)">Leak Tank</button>
  </div>
  <div class="btn-row">
    <button style="background:#4caf50;color:#fff;font-weight:bold" onclick="stopSimLeak()">â–  Stop Leak</button>
  </div>
  <div style="font-size:11px;color:#666;margin-top:4px">Aggressive leak ~1.5 PSI/sec. Requires demo mode ON. Use to test leak monitor &amp; UI alerts.</div>
</div>

<!-- Sensor Calibration -->
<div class="section">
  <h2>Sensor Calibration</h2>
  <div id="cal-status" style="font-size:12px;margin-bottom:6px;color:#888">Loading calibration...</div>
  <div id="cal-sensors"></div>
  <div style="margin-top:8px">
    <div class="btn-row">
      <button style="background:#c62828;color:#fff;font-weight:bold" onclick="calResetAll()">Reset All to Factory</button>
      <button style="background:#1565c0;color:#fff" onclick="calRefresh()">Refresh</button>
    </div>
  </div>
  <div style="font-size:11px;color:#555;margin-top:6px">
    <strong>Two-point calibration:</strong> 1) Dump bags to 0 PSI, click "Set Zero". 2) Fill to known pressure (use trusted gauge), enter reference PSI, click "Set Span".<br>
    <strong>Nudge:</strong> Fine-tune offset by &plusmn;0.5 PSI while comparing to a reference gauge.<br>
    <strong>Ref Resistor:</strong> Enter measured resistance of your voltage divider resistor (default 100&Omega;).
  </div>
</div>

<!-- Raw Endpoints -->
<div class="section">
  <h2>Raw Endpoint Test</h2>
  <div class="config">
    <input type="text" id="raw-path" value="/s" placeholder="/s, /b?n=0&d=1, etc.">
    <button onclick="rawFetch()">GET</button>
  </div>
</div>

<!-- Log -->
<h2>Request Log</h2>
<div id="log"></div>
<h2>Last Raw Response</h2>
<div id="raw"></div>

<script>
const BAGS = ['FL', 'FR', 'RL', 'RR'];
const BAG_LABELS = { FL: 'Front Left', FR: 'Front Right', RL: 'Rear Left', RR: 'Rear Right' };
let polling = false;
let pollTimer = null;
let state = { bags: [0,0,0,0], targets: [0,0,0,0], tank: 0, timeouts: [false,false,false,false], level: 0, lockout: false, pumpEnabled: true, demo: false, pump: '', runtime: '', presets: null, maint: null, maintOverdue: false, tankMaint: null, simLeak: null };

function ev(e) { e.preventDefault(); }
function getBase() { return document.getElementById('base-url').value.replace(/\/+$/, ''); }

function log(type, msg) {
  const el = document.getElementById('log');
  const line = document.createElement('div');
  line.className = type;
  const ts = new Date().toLocaleTimeString();
  line.textContent = `[${ts}] ${msg}`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
  // Keep last 100 lines
  while (el.children.length > 100) el.removeChild(el.firstChild);
}

async function api(path) {
  const url = getBase() + path;
  log('req', `GET ${path}`);
  try {
    const r = await fetch(url, { signal: AbortSignal.timeout(2000) });
    const text = await r.text();
    log('res', `${r.status} (${text.length}b)`);
    document.getElementById('raw').textContent = text;
    try {
      const sanitized = text.replace(/\bnan\b/gi, '0').replace(/\b-?inf\b/gi, '0');
      return JSON.parse(sanitized);
    } catch { return text; }
  } catch (e) {
    log('err', `FAIL: ${e.message}`);
    document.getElementById('raw').textContent = `Error: ${e.message}`;
    return null;
  }
}

function updateUI() {
  // Connection status
  const dot = document.getElementById('conn-dot');
  const txt = document.getElementById('conn-text');
  // Tank
  document.getElementById('tank-psi').textContent = state.tank.toFixed(1);
  document.getElementById('tank-bar-fill').style.width = Math.min(100, (state.tank / 150) * 100) + '%';
  const lockout = document.getElementById('lockout-warn');
  lockout.style.display = state.lockout ? '' : 'none';

  // Bags
  const grid = document.getElementById('bags-grid');
  if (!grid.children.length) {
    for (let i = 0; i < 4; i++) {
      const card = document.createElement('div');
      card.className = 'bag-card';
      card.id = `bag-${i}`;
      card.innerHTML = `
        <div class="name">${BAG_LABELS[BAGS[i]]}</div>
        <div class="psi" id="bag-psi-${i}">--</div>
        <div class="target" id="bag-target-${i}">Target: --</div>
        <div class="timeout" id="bag-timeout-${i}" style="display:none">SOLENOID TIMEOUT</div>
        <div class="bag-btns">
          <button class="inflate" onmousedown="bagAction(${i},1)" onmouseup="bagHold(${i})" ontouchstart="ev(event);bagAction(${i},1)" ontouchend="ev(event);bagHold(${i})">+</button>
          <button class="hold" onclick="bagHold(${i})">H</button>
          <button class="deflate" onmousedown="bagAction(${i},-1)" onmouseup="bagHold(${i})" ontouchstart="ev(event);bagAction(${i},-1)" ontouchend="ev(event);bagHold(${i})">-</button>
        </div>
        <div class="target-input">
          <input type="number" id="bag-target-input-${i}" min="0" max="120" value="0" step="5">
          <button onclick="setBagTarget(${i})">Set</button>
        </div>
      `;
      grid.appendChild(card);
    }
  }
  for (let i = 0; i < 4; i++) {
    document.getElementById(`bag-psi-${i}`).textContent = state.bags[i].toFixed(1);
    document.getElementById(`bag-target-${i}`).textContent = `Target: ${state.targets[i].toFixed(0)} PSI`;
    const to = document.getElementById(`bag-timeout-${i}`);
    to.style.display = state.timeouts[i] ? '' : 'none';
  }

  // Level
  for (let i = 0; i <= 3; i++) {
    const btn = document.getElementById(`level-${i}`);
    btn.classList.toggle('active', state.level === i);
  }

  // Pumps
  document.getElementById('pump-enabled').textContent = state.pumpEnabled ? 'YES' : 'NO';
  document.getElementById('pump-enabled').style.color = state.pumpEnabled ? '#4caf50' : '#f44336';
  document.getElementById('pump-mode').textContent = state.pump || '--';
  const p1 = state.pump && state.pump.includes('P1:ON');
  const p2 = state.pump && state.pump.includes('P2:ON');
  document.getElementById('p1-led').className = `pump-led ${p1 ? 'on' : 'off'}`;
  document.getElementById('p2-led').className = `pump-led ${p2 ? 'on' : 'off'}`;
  document.getElementById('pump-runtime').textContent = state.runtime || '';
  const toggleBtn = document.getElementById('pump-toggle-btn');
  toggleBtn.className = `pump ${state.pumpEnabled ? '' : 'off'}`;
  toggleBtn.textContent = state.pumpEnabled ? 'Disable Pumps' : 'Enable Pumps';

  // Maintenance
  const maintEl = document.getElementById('pump-maint');
  if (state.maint) {
    maintEl.textContent = state.maint;
    maintEl.style.color = state.maintOverdue ? '#f44336' : '#ffa726';
  } else {
    maintEl.textContent = '';
  }

  // Demo mode
  const demoBtn = document.getElementById('demo-toggle-btn');
  const demoStatus = document.getElementById('demo-status');
  demoBtn.className = state.demo ? 'demo' : 'demo off';
  demoBtn.textContent = state.demo ? 'Disable Demo' : 'Enable Demo';
  demoStatus.className = `demo-status ${state.demo ? 'on' : 'off'}`;
  demoStatus.textContent = state.demo ? 'DEMO: ON' : 'DEMO: OFF';

  // Presets
  if (state.presets) {
    const names = ['Lay', 'Cruise', 'Max'];
    const lines = state.presets.map((p, i) =>
      `${names[i]}: FL=${p[0]} FR=${p[1]} RL=${p[2]} RR=${p[3]}`
    );
    document.getElementById('preset-values').textContent = lines.join(' | ');
  }

  // Tank Maintenance
  const tm = state.tankMaint;
  const tmStatus = document.getElementById('tank-maint-status');
  const tmDays = document.getElementById('tank-maint-days');
  const tmLast = document.getElementById('tank-maint-last');
  if (tm && tm.valid) {
    if (!tm.timeSynced) {
      tmStatus.textContent = 'WAITING FOR TIME SYNC';
      tmStatus.style.color = '#888';
      tmDays.textContent = '--';
    } else if (tm.due) {
      tmStatus.textContent = 'SERVICE DUE';
      tmStatus.style.color = '#f44336';
      tmDays.textContent = tm.daysRemaining <= 0 ? `${Math.abs(tm.daysRemaining)} days overdue` : `${tm.daysRemaining}`;
      tmDays.style.color = '#f44336';
    } else {
      tmStatus.textContent = 'OK';
      tmStatus.style.color = '#4caf50';
      tmDays.textContent = String(tm.daysRemaining);
      tmDays.style.color = '#4caf50';
    }
    if (tm.lastService) {
      tmLast.textContent = 'Last service: ' + new Date(tm.lastService * 1000).toLocaleString();
    }
  } else {
    tmStatus.textContent = 'NOT SET';
    tmStatus.style.color = '#888';
    tmDays.textContent = '--';
    tmLast.textContent = 'Last service: --';
  }

  // Simulated Leak
  const sl = state.simLeak;
  const slStatus = document.getElementById('simleak-status');
  const slTarget = document.getElementById('simleak-target');
  if (sl && sl.active) {
    slStatus.textContent = 'LEAKING';
    slStatus.style.color = '#f44336';
    slTarget.textContent = sl.targetName || ('index ' + sl.target);
    slTarget.style.color = '#f44336';
  } else {
    slStatus.textContent = 'INACTIVE';
    slStatus.style.color = '#4caf50';
    slTarget.textContent = '--';
    slTarget.style.color = '#888';
  }

  document.getElementById('last-update').textContent = 'Updated: ' + new Date().toLocaleTimeString();
}

async function pollNow() {
  const data = await api('/s');
  if (data && typeof data === 'object') {
    state.bags = data.bags || [0,0,0,0];
    state.targets = data.targets || [0,0,0,0];
    state.tank = data.tank || 0;
    state.timeouts = data.timeouts || [false,false,false,false];
    state.level = data.level || 0;
    state.lockout = data.lockout || false;
    state.pumpEnabled = data.pumpEnabled !== false;
    state.demo = data.demo || false;
    state.pump = data.pump || '';
    state.runtime = data.runtime || '';
    state.presets = data.presets || null;
    state.maint = data.maint || null;
    state.maintOverdue = data.maintOverdue || false;
    state.tankMaint = data.tankMaint || null;
    state.simLeak = data.simLeak || null;
    document.getElementById('conn-dot').className = 'dot ok';
    document.getElementById('conn-text').textContent = 'Connected';
  } else {
    document.getElementById('conn-dot').className = 'dot err';
    document.getElementById('conn-text').textContent = 'Disconnected';
  }
  updateUI();
}

function togglePoll() {
  polling = !polling;
  document.getElementById('poll-toggle').textContent = `Auto-poll: ${polling ? 'ON' : 'OFF'}`;
  if (polling) {
    pollNow();
    pollTimer = setInterval(pollNow, 500);
  } else {
    clearInterval(pollTimer);
    pollTimer = null;
  }
}

// Bag controls
async function bagAction(n, dir) { await api(`/b?n=${n}&d=${dir}&h=1`); }
async function bagHold(n) { await api(`/bh?n=${n}`); }
async function setBagTarget(n) {
  const psi = document.getElementById(`bag-target-input-${n}`).value;
  await api(`/bt?n=${n}&t=${psi}`);
  if (!polling) pollNow();
}
async function allBags(dir) {
  for (let i = 0; i < 4; i++) api(`/b?n=${i}&d=${dir}&h=1`);
}
async function allBagsHold() {
  for (let i = 0; i < 4; i++) api(`/bh?n=${i}`);
}

// Presets
async function applyPreset(n) { await api(`/p?n=${n}`); if (!polling) pollNow(); }
async function savePreset(n) {
  // Save current bag pressures as the preset
  const fl = Math.round(state.bags[0]);
  const fr = Math.round(state.bags[1]);
  const rl = Math.round(state.bags[2]);
  const rr = Math.round(state.bags[3]);
  await api(`/sp?n=${n}&fl=${fl}&fr=${fr}&rl=${rl}&rr=${rr}`);
  if (!polling) pollNow();
}

// Level
async function setLevel(m) { await api(`/l?m=${m}`); if (!polling) pollNow(); }

// Pumps
async function togglePump() { await api('/po'); if (!polling) pollNow(); }

// Demo mode
async function toggleDemo() { await api('/demo'); if (!polling) pollNow(); }

// Tank maintenance
async function resetTankMaint() { await api('/tank?reset=1'); if (!polling) pollNow(); }
async function setTankMaintDate() {
  const dateStr = prompt('Enter service date (YYYY-MM-DD):', new Date().toISOString().slice(0, 10));
  if (!dateStr) return;
  const epoch = Math.floor(new Date(dateStr).getTime() / 1000);
  if (isNaN(epoch) || epoch < 1600000000) { alert('Invalid date'); return; }
  await api(`/tank?set=${epoch}`);
  if (!polling) pollNow();
}

// Simulated leak
async function startSimLeak(target) { await api(`/simleak?target=${target}`); if (!polling) pollNow(); }
async function stopSimLeak() { await api('/simleak?stop=1'); if (!polling) pollNow(); }

// Raw endpoint
async function rawFetch() {
  const path = document.getElementById('raw-path').value;
  await api(path);
  if (!polling) pollNow();
}

// Sync browser time to ESP32
fetch(getBase() + '/time?t=' + Math.floor(Date.now() / 1000)).catch(() => {});

// ============================================
// SENSOR CALIBRATION
// ============================================

let calData = null;

async function calRefresh() {
  const data = await api('/cal');
  if (data && data.sensors) {
    calData = data.sensors;
    renderCalibration();
  } else {
    document.getElementById('cal-status').textContent = 'Failed to load calibration data';
    document.getElementById('cal-status').style.color = '#f44336';
  }
}

function renderCalibration() {
  if (!calData) return;
  const container = document.getElementById('cal-sensors');
  container.innerHTML = '';

  const anyCalibrated = calData.some(s => s.calibrated);
  document.getElementById('cal-status').textContent = anyCalibrated
    ? 'Custom calibration active'
    : 'All sensors using factory defaults';
  document.getElementById('cal-status').style.color = anyCalibrated ? '#4caf50' : '#888';

  calData.forEach((sensor, idx) => {
    const card = document.createElement('div');
    card.className = 'cal-card';
    card.innerHTML = `
      <div class="cal-header">
        <span class="cal-name">${sensor.name}</span>
        <span class="cal-badge ${sensor.calibrated ? 'calibrated' : 'factory'}">${sensor.calibrated ? 'CALIBRATED' : 'FACTORY'}</span>
        <span class="cal-psi">${sensor.currentPsi.toFixed(1)} PSI</span>
      </div>
      <div class="cal-values">
        Offset: ${sensor.offset.toFixed(3)} PSI | Gain: ${sensor.gain.toFixed(4)} | Ref R: ${sensor.refResistor.toFixed(1)}&Omega;
      </div>
      <div class="cal-row">
        <button style="background:#2e7d32" onclick="calZero(${idx})">Set Zero</button>
        <span class="cal-label">Span:</span>
        <input type="number" id="cal-span-${idx}" min="1" max="150" value="80" step="1" placeholder="Ref PSI">
        <button style="background:#1565c0" onclick="calSpan(${idx})">Set Span</button>
        <button style="background:#555" onclick="calNudge(${idx}, -0.5)">-0.5</button>
        <button style="background:#555" onclick="calNudge(${idx}, 0.5)">+0.5</button>
      </div>
      <div class="cal-row">
        <span class="cal-label">Ref R:</span>
        <input type="number" id="cal-ref-${idx}" min="80" max="120" value="${sensor.refResistor.toFixed(1)}" step="0.1" placeholder="Ohms">
        <button style="background:#6a1b9a" onclick="calSetRef(${idx})">Set</button>
        <button style="background:#c62828" onclick="calReset(${idx})">Reset</button>
      </div>
    `;
    container.appendChild(card);
  });
}

async function calZero(sensorIdx) {
  if (!calData) return;
  const currentPsi = calData[sensorIdx].currentPsi;
  const gain = calData[sensorIdx].gain;
  // To zero: we need the raw PSI (before calibration)
  // rawPsi = (currentPsi - offset) / gain
  const rawPsi = (currentPsi - calData[sensorIdx].offset) / gain;
  if (!confirm(`Set Zero for ${calData[sensorIdx].name}?\nCurrent reading: ${currentPsi.toFixed(1)} PSI\nThis sensor should read 0 PSI right now.`)) return;
  await api(`/cal?s=${sensorIdx}&zero=${rawPsi.toFixed(3)}`);
  await calRefresh();
  if (!polling) pollNow();
}

async function calSpan(sensorIdx) {
  if (!calData) return;
  const refPsi = parseFloat(document.getElementById(`cal-span-${sensorIdx}`).value);
  if (isNaN(refPsi) || refPsi <= 0) { alert('Enter a valid reference PSI'); return; }
  const sensor = calData[sensorIdx];
  // Get raw PSI (before calibration)
  const rawPsi = (sensor.currentPsi - sensor.offset) / sensor.gain;
  if (rawPsi < 0.1) { alert('Current pressure too low for span calibration. Fill to reference pressure first.'); return; }
  if (!confirm(`Set Span for ${sensor.name}?\nCurrent raw: ${rawPsi.toFixed(1)} PSI\nReference gauge: ${refPsi.toFixed(1)} PSI`)) return;
  await api(`/cal?s=${sensorIdx}&span_raw=${rawPsi.toFixed(3)}&span_ref=${refPsi.toFixed(3)}`);
  await calRefresh();
  if (!polling) pollNow();
}

async function calNudge(sensorIdx, delta) {
  if (!calData) return;
  const newOffset = calData[sensorIdx].offset + delta;
  await api(`/cal?s=${sensorIdx}&o=${newOffset.toFixed(3)}`);
  await calRefresh();
  if (!polling) pollNow();
}

async function calSetRef(sensorIdx) {
  const refR = parseFloat(document.getElementById(`cal-ref-${sensorIdx}`).value);
  if (isNaN(refR) || refR < 80 || refR > 120) { alert('Enter a valid resistance (80-120 ohms)'); return; }
  await api(`/cal?s=${sensorIdx}&r=${refR.toFixed(1)}`);
  await calRefresh();
  if (!polling) pollNow();
}

async function calReset(sensorIdx) {
  if (!calData) return;
  if (!confirm(`Reset ${calData[sensorIdx].name} to factory defaults?`)) return;
  await api(`/calreset?s=${sensorIdx}`);
  await calRefresh();
  if (!polling) pollNow();
}

async function calResetAll() {
  if (!confirm('Reset ALL sensors to factory calibration defaults?')) return;
  await api('/calreset');
  await calRefresh();
  if (!polling) pollNow();
}

// Build initial UI
updateUI();

// Load calibration on page load
calRefresh();
</script>
</body>
</html>
